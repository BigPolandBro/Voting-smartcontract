
<!DOCTYPE html> 

<html> 

<head> 

<meta charset="UTF-8"> 

<script type="text/javascript"> 

var abi = [
	{
		"inputs": [
			{
				"internalType": "bytes32[]",
				"name": "candNames",
				"type": "bytes32[]"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "message",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "returnValue",
				"type": "string"
			}
		],
		"name": "PaymentEvent",
		"type": "event"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "IsAdmin",
		"outputs": [
			{
				"internalType": "uint32",
				"name": "",
				"type": "uint32"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "string",
				"name": "s1",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "s2",
				"type": "string"
			}
		],
		"name": "addString",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "_bytes32",
				"type": "bytes32"
			}
		],
		"name": "bytes32ToString",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "candidates",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "name",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "voteCount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "uint256",
				"name": "candidate",
				"type": "uint256"
			}
		],
		"name": "doPayment",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getString2",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "getVotingList",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"internalType": "address",
				"name": "voter",
				"type": "address"
			}
		],
		"name": "giveRightToVote",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "kill",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "voters",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "weight",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "voted",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "vote",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "winnerName",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "winningCandidate",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "winningCandidate_",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
];

var address = "0x641571eAe82a17086eA9A832953CD2D2A3294060";  

window.addEventListener('load', async() => { 

   /// Modern dapp browsers 

   if (window.ethereum) { 

      window.web3 = new Web3(window.ethereum);                 
    } 

   // Old dapp browsers

    else if (window.web3) { 

      window.web3 = new Web3(web3.currentProvider);                 

    } 

   // Non-dapp browsers 

    else { 

      console.log('Your browser do not support Ethereum! Install MetaMask plugin!'); 

            } 
}); 


function payment() { 

web3.eth.getAccounts(function(error, acc)  

{ 

defaultAccount=acc[0]; 

console.log("defaultAccount="+defaultAccount); 

contract = web3.eth.contract(abi).at(address); 

console.log(contract); 

if (document.getElementById('can1').checked)  {
     candidate_num = document.getElementById('can1').value;
}
if (document.getElementById('can2').checked)  {
     candidate_num = document.getElementById('can2').value;
}
if (document.getElementById('can3').checked)  {
     candidate_num = document.getElementById('can3').value;
}

sum = web3.toWei(0.3, 'ether'); 

contract.doPayment.sendTransaction(candidate_num,

{
 
from: defaultAccount, 				 

value: sum

},  

function(error, data) { 

 if(error!=null) console.log(error); 

                       console.log("Data="+data); 

                }); 

}); 

}

function giveRightToVote() {

web3.eth.getAccounts(function(error, acc)  
{ 

	defaultAccount=acc[0]; 

	console.log("defaultAccount="+defaultAccount); 

	contract = web3.eth.contract(abi).at(address); 

	console.log(contract);
     
	voter_address = document.getElementById('voter_address').value
	 
	sum = web3.toWei(1, 'ether'); 

	contract.giveRightToVote.sendTransaction(voter_address,

{
 
from: defaultAccount, 				 

value: sum

},  

function(error, data) { 

 if(error!=null) console.log(error); 

                       console.log("Data="+data); 

                }); 

});
}


function getVotingList() {

	contract = web3.eth.contract(abi).at(address); 
	contract.getVotingList.call({from:address}, function(err,data){
	console.log(data);
	document.getElementById("voting_list").innerHTML = data;

});
}


function getWinner() {

	contract = web3.eth.contract(abi).at(address); 
	contract.winnerName.call({from:address}, function(err,data) {
	console.log(data);
	document.getElementById("winner").innerHTML = data;
  });
}

</script>

</head> 

<body background="voter.jpeg"> 

    <center><h1><font color="#4B0082"><hr><b>Voting page</b><hr></font></h1></center>
	<form>
	  <fieldset>
	    <legend><h3>Choose candidate:</h3></legend>
        <div>
          <input type="radio" id="can1"
          name="contact1" value="0">
          <label for="can1">Иванов И. И.</label>
        </div>
	    <div>
          <input type="radio" id="can2"
           name="contact1" value="1">
          <label for="can2">Петров П. П.</label>
        </div>
	    <div>
          <input type="radio" id="can3"
           name="contact1" value="2">
          <label for="can3">Сидоров С. С.</label>
        </div>
		<br>
        <div>
          <button type="button" onClick="payment();"><b>Vote</b></button>
        </div>
	  </fieldset>
    </form>
	<br><br>    
	<button type="button" onClick="getWinner();"><b>Show the winner</b></button>
	<p id="winner"></p>
	<br><br><br>
	<form action="http://localhost/main.html">
    <center><button><b>To the main page</b></button></center>
</body>  
</html> 

